
# RK3588 摄像头服务器项目开发日志

## 项目概述

**项目名称**：RK3588 摄像头服务器与 Web 客户端
**开发开始日期**：[当前日期]
**开发团队**：[团队成员]
**开发平台**：RK3588 开发板（如香橙派 5 Plus）

### 项目背景

本项目旨在利用瑞芯微 RK3588 开发板的硬件能力，构建一个功能强大的摄像头服务器。该服务器能够连接摄像头，实现视频流的采集、编码和录制，并支持将已录制的视频文件拆解为一系列静态图像帧。项目同时包含一个基于 Web 浏览器的客户端界面，用户可以通过任何设备的浏览器远程访问、控制服务器的功能并获取其状态信息。

### 核心目标

- 提供稳定、高效的远程摄像头解决方案
- 支持高质量视频录制和后续的图像帧提取
- 通过通用的 Web 浏览器提供便捷的访问和控制方式
- 充分利用 RK3588 的硬件加速能力

### 主要功能

1. **视频采集**：
   - 摄像头开启和关闭控制
   - 实时视频预览控制
   - 从连接的摄像头获取视频流

2. **视频录制**：
   - 将视频流编码并保存为视频文件
   - 视频文件管理（列表、删除、重命名等）

3. **视频拆分**：
   - 将视频文件拆分为静态图像帧
   - 静态帧文件和文件夹管理
   - 静态帧文件夹打包功能
   - 通过浏览器下载打包文件

4. **远程控制**：
   - 通过 Web 界面远程控制和管理上述功能
   - 摄像头参数控制（分辨率、帧率等）

5. **系统监控**：
   - 监控和显示系统状态信息

## 技术栈选择

### 主要技术栈

- **编程语言**：Rust（服务器端）、HTML/CSS/JavaScript（Web 客户端）
- **操作系统**：Radxa OS 或 Armbian（基于 Debian/Ubuntu 的 RK3588 优化版本）
- **Web 框架**：Actix-web（Rust）
- **视频处理**：FFmpeg（通过 ffmpeg-next 绑定）
- **摄像头接口**：V4L2（通过 v4l2-rs 或 nokhwa 库）
- **前端框架**：待定（可能使用 React、Vue 或纯 JavaScript）

### 为什么选择 Rust？

1. **性能与安全性**：Rust 提供接近 C/C++ 的性能，同时通过所有权系统保证内存安全，这对处理视频流这类资源密集型任务非常重要。

2. **并发处理能力**：Rust 的并发模型可以帮助高效处理多任务（如同时进行视频采集、编码和 API 服务）。

3. **系统级编程**：Rust 适合与底层硬件和系统 API 交互，这对于访问摄像头设备和硬件加速功能至关重要。

4. **错误处理**：Rust 的错误处理机制有助于构建健壮的系统，能够优雅地处理各种异常情况。

5. **生态系统**：Rust 拥有丰富的库生态系统，包括视频处理、Web 服务和系统监控等领域。

## 项目架构

### 模块划分

1. **摄像头采集模块**（camera-core）
   - 摄像头设备检测和初始化
   - 视频流采集
   - 采集参数配置（分辨率、帧率等）
   - 实时预览流处理

2. **视频处理模块**（camera-core）
   - 视频编码和录制
   - 视频文件管理
   - 视频拆分为图像帧

3. **API 服务模块**（camera-api）
   - RESTful API 接口
   - Web 服务器（提供静态文件）
   - 文件下载服务
   - 不包含认证功能

4. **存储管理模块**（camera-storage）
   - 文件系统操作
   - 文件命名和组织
   - 存储空间管理
   - 静态帧文件夹管理
   - 文件打包功能

5. **系统监控模块**（camera-monitor）
   - 系统资源监控（CPU、内存、存储）
   - 服务状态监控
   - 日志记录和管理

6. **主应用**（camera-app）
   - 集成所有模块
   - 配置管理
   - 命令行界面

### 项目结构

```
camera-server/
├── Cargo.toml (workspace)
├── camera-core/       # 摄像头采集和视频处理核心功能
├── camera-api/        # API服务和Web服务器
├── camera-storage/    # 存储管理功能
├── camera-monitor/    # 系统监控功能
├── camera-app/        # 主应用，集成其他crate
└── web-client/        # Web客户端（HTML/CSS/JS）
```

## 开发计划

### 第一阶段：基础框架搭建（预计时间：1周）

- [x] 创建项目结构和 Cargo 工作空间
- [ ] 实现基本的配置加载和日志系统
- [ ] 搭建简单的 API 服务器框架
- [x] 设计并实现核心数据结构

### 第二阶段：摄像头采集模块（预计时间：X周）

- [ ] 实现摄像头设备检测和初始化
- [ ] 实现视频流采集功能
- [ ] 添加采集参数配置（分辨率、帧率等）
- [ ] 实现摄像头开启和关闭控制
- [ ] 实现实时预览流处理
- [ ] 测试不同摄像头设备的兼容性

### 第三阶段：视频处理模块（预计时间：X周）

- [ ] 实现视频编码和录制功能
- [ ] 实现视频文件管理（列表、删除、重命名）
- [ ] 实现视频拆分为图像帧的功能
- [ ] 实现静态帧文件和文件夹管理
- [ ] 实现静态帧文件夹打包功能
- [ ] 优化硬件加速使用

### 第四阶段：API和集成（预计时间：X周）

- [ ] 完善 RESTful API 接口
- [ ] 实现文件下载服务
- [ ] 实现系统监控功能
- [ ] 集成所有模块，确保协同工作
- [ ] 开发基本的 Web 客户端界面

### 第五阶段：优化和测试（预计时间：X周）

- [ ] 性能优化，特别是视频处理部分
- [ ] 全面测试各个功能
- [ ] 编写详细文档
- [ ] 完善 Web 客户端界面
- [ ] 优化用户体验

## 开发日志

### 2025-04-20 - 项目初始化

**完成工作**：
- 创建项目仓库
- 设计项目架构
- 确定技术栈
- 创建开发日志文档
- 确认项目必要功能

**遇到的问题**：
- 暂无

**下一步计划**：
- 创建基础项目结构
- 实现基本的配置加载和日志系统

### 2025-04-21 - 基础框架搭建

**完成工作**：
- 创建项目结构和Cargo工作空间
- 实现模块划分（camera-core, camera-api, camera-storage, camera-monitor, camera-app）
- 创建基础的Web客户端界面
- 设计并实现核心数据结构
- 初始化Git仓库并提交到GitHub

**遇到的问题**：
- 开发环境选择：是在Mac上开发后移植到RK3588，还是直接在RK3588上开发
- 解决方案：采用混合开发模式，在Mac上开发基础功能，在RK3588上开发硬件相关功能

**下一步计划**：
- 在Mac上安装Rust开发环境
- 实现摄像头设备检测和初始化
- 实现视频流采集功能
- 添加采集参数配置（分辨率、帧率等）

### 2025-04-22 - 开发环境设置

**完成工作**：
- 创建Mac开发环境设置脚本（setup_mac_dev.sh）
- 创建RK3588开发环境设置脚本（setup_rk3588_dev.sh）
- 设计混合开发工作流程
- 更新项目文档

**遇到的问题**：
- 需要确保Mac和RK3588环境的一致性
- 解决方案：创建详细的环境设置脚本，确保依赖版本一致

**下一步计划**：
- 实现摄像头模块基础功能
- 测试交叉编译到RK3588的可行性

### 2025-04-23 - 摄像头检测和图像捕获功能实现

**完成工作**：
- 在Mac上安装Rust开发环境
- 实现跨平台摄像头检测功能
- 实现基本的图像捕获功能
- 添加错误处理和模拟图像生成
- 修改camera-core模块，使其能在Mac上正常工作

**遇到的问题**：
- FFmpeg兼容性问题：ffmpeg-next库与系统上的FFmpeg版本不兼容
  - 解决方案：暂时注释掉ffmpeg-next依赖，专注于基础功能
- 像素格式转换问题：Mac摄像头使用NV12格式，而我们尝试转换为RGB格式时遇到了问题
  - 解决方案：添加错误处理，在转换失败时生成模拟图像
- nokhwa库API变化：库的API有所变化，需要调整代码
  - 解决方案：修改代码，使用新的API格式

**下一步计划**：
- 改进像素格式处理
- 实现视频录制功能
- 开发API服务
- 测试交叉编译到RK3588平台

### 2025-05-13 - 视频录制功能和API服务开发

**完成工作**：
- 改进了像素格式处理，解决了Mac摄像头NV12格式转换问题
- 实现了基本的视频录制功能，支持MP4和MKV容器格式
- 开发了初步的API服务，提供摄像头控制和状态查询接口
- 创建了测试工具，验证摄像头捕获和视频录制功能
- 优化了跨平台代码，确保在Mac和Linux环境下都能正常工作

**遇到的问题**：
- 视频编码性能问题：在Mac上使用软件编码时CPU占用较高
  - 解决方案：添加编码参数优化，降低编码复杂度，为RK3588硬件编码做准备
- API服务并发处理：处理多个客户端同时请求时出现竞态条件
  - 解决方案：使用Tokio互斥锁和Arc包装共享资源，确保线程安全
- 文件存储管理：需要处理大量视频文件和图像帧的存储和组织
  - 解决方案：实现了基于时间戳的文件命名和目录结构，便于后续管理

**下一步计划**：
- 完善Web客户端界面，提供直观的用户交互
- 实现视频拆分为图像帧功能
- 测试在RK3588上的部署和性能
- 添加系统监控功能，实时显示资源使用情况

### 2025-05-13 - 平台转换：从Mac转向RK3588

**完成工作**：
- 更新了项目文档，将开发环境从Mac转向RK3588
- 修改了DEV_PLATFORM.md，反映直接在RK3588上开发的决策
- 更新了DEV_ENVIRONMENT.md，添加RK3588特定的环境信息
- 清理了Mac特定的工具和代码
- 优化了RK3588开发环境设置脚本
- 实现了直接生成JPEG格式图像的功能，提高效率

**遇到的问题**：
- NV12格式处理问题：Mac摄像头输出的NV12格式数据难以正确转换为RGB
  - 解决方案：创建彩色渐变测试图案，验证图像处理管道，并实现直接JPEG编码
- 跨平台代码复杂性：维护同时支持Mac和RK3588的代码增加了复杂性
  - 解决方案：决定放弃Mac平台支持，专注于RK3588平台，简化代码
- 开发环境差异：Mac和RK3588环境差异导致一些兼容性问题
  - 解决方案：直接在RK3588上进行开发，避免环境差异问题

**下一步计划**：
- 移除所有Mac特定的条件编译代码
- 优化V4L2摄像头接口，提高性能
- 实现RK3588硬件编码加速
- 测试USB摄像头在RK3588上的兼容性
- 开发RK3588特定的测试工具

## 技术挑战与解决方案

### 挑战1：在 RK3588 上高效使用 FFmpeg 的硬件加速

**描述**：RK3588 提供了硬件视频编解码能力，但需要正确配置 FFmpeg 才能利用这些功能。

**解决方案**：
- 研究 Rockchip 提供的 FFmpeg 补丁和配置
- 测试不同的编码参数和选项
- 可能需要编写自定义的 FFmpeg 配置代码

### 挑战2：高效的视频帧提取

**描述**：从视频文件提取图像帧可能是计算密集型操作，需要优化以提高性能。

**解决方案**：
- 利用 FFmpeg 的场景检测功能
- 使用多线程并行处理
- 研究增量提取策略

### 挑战3：实时视频预览的低延迟传输

**描述**：通过Web浏览器提供低延迟的实时视频预览可能面临网络带宽和浏览器兼容性问题。

**解决方案**：
- 研究WebRTC或HLS等流媒体协议
- 实现自适应比特率流
- 考虑使用WebSocket传输MJPEG流作为备选方案

### 挑战4：大文件打包和下载

**描述**：静态帧文件夹可能包含大量图像，打包和下载可能面临内存和网络带宽限制。

**解决方案**：
- 实现流式打包，避免一次性加载所有文件到内存
- 提供分块下载功能
- 实现断点续传

### 挑战5：跨平台开发与部署

**描述**：在 x86 开发机上开发，然后部署到 ARM64 架构的 RK3588 上可能面临兼容性问题。

**解决方案**：
- 设置交叉编译环境
- 使用 Docker 容器进行开发和测试
- 编写自动化部署脚本

## 参考资源

### 官方文档

- [Rust 官方文档](https://www.rust-lang.org/learn)
- [Actix-web 文档](https://actix.rs/docs/)
- [FFmpeg 文档](https://ffmpeg.org/documentation.html)
- [V4L2 API 文档](https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html)
- [RK3588 技术文档](https://wiki.radxa.com/Rock5/hardware/5B)

### 教程和示例

- [Rust FFmpeg 示例](https://github.com/zmwangx/rust-ffmpeg-examples)
- [V4L2 编程指南](https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html)
- [Actix-web 示例](https://github.com/actix/examples)
- [WebRTC 示例](https://webrtc.github.io/samples/)

### 社区资源

- [Rust 论坛](https://users.rust-lang.org/)
- [FFmpeg 邮件列表](https://ffmpeg.org/mailman/listinfo/ffmpeg-user/)
- [Rockchip 开发者社区](https://forum.radxa.com/)

## 项目状态跟踪

### 当前状态

- **阶段**：平台转换和视频处理模块开发
- **完成度**：40%
- **关键里程碑**：项目架构设计完成，基础框架搭建完成，摄像头检测和图像捕获功能实现，基本视频录制功能实现，初步API服务开发，平台从Mac转向RK3588

### 待解决问题

- [x] 确定具体的硬件设备型号和规格（RK3588开发板）
- [x] 验证 Rust 在 RK3588 上的开发可行性
- [ ] 测试 FFmpeg 硬件加速在RK3588上的性能
- [ ] 评估实时视频预览的最佳传输方式
- [ ] 研究高效的文件打包和下载方法
- [x] 实现摄像头设备检测和初始化
- [x] 实现基本的图像捕获功能
- [x] 实现视频流采集和录制功能
- [ ] 实现RK3588硬件编码加速
- [ ] 优化V4L2摄像头接口性能
- [ ] 实现视频拆分为图像帧功能
- [ ] 完善Web客户端界面
- [ ] 添加系统监控功能

### 决策记录

| 日期 | 决策 | 原因 | 替代方案 | 影响 |
|------|------|------|----------|------|
| 2025-04-20 | 使用 Rust 作为主要开发语言 | 性能、安全性和并发处理能力 | Go, C++ | 学习曲线可能较陡，但长期维护性更好 |
| 2025-04-20 | 使用 Actix-web 作为 Web 框架 | 性能优秀，异步支持良好 | Rocket, Warp | 更复杂的 API，但提供更好的性能和灵活性 |
| 2025-04-21 | 采用混合开发模式 | 结合Mac开发环境的便利性和RK3588的硬件特性 | 纯Mac开发或纯RK3588开发 | 开发效率提高，但需要处理交叉编译和环境一致性问题 |
| 2025-04-23 | 使用nokhwa库实现跨平台摄像头访问 | 提供统一的API访问不同平台的摄像头 | 分别使用V4L2和AVFoundation | 简化代码，提高可维护性，但增加了依赖 |
| 2025-05-13 | 暂时使用软件编码实现视频录制 | 确保跨平台兼容性，先实现基本功能 | 直接使用硬件编码 | 在Mac上性能较低，但保证了功能的可用性，为后续优化留出空间 |
| 2025-05-13 | 放弃Mac平台，转向纯RK3588开发 | 简化代码，避免跨平台兼容性问题，充分利用RK3588硬件特性 | 继续混合开发模式 | 代码更简洁，性能更优，但放弃了在Mac上开发的便利性 |

## 附录

### 环境设置指南

```bash
# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 安装交叉编译工具链
rustup target add aarch64-unknown-linux-gnu

# 安装必要的系统依赖
sudo apt-get install -y \
    build-essential \
    pkg-config \
    libssl-dev \
    libv4l-dev \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswscale-dev
```

### 有用的命令

```bash
# 构建整个工作空间
cargo build --workspace

# 运行特定的二进制
cargo run -p camera-app

# 运行测试
cargo test --workspace

# 交叉编译
cargo build --target aarch64-unknown-linux-gnu --release
```

---

*注：此开发日志将随着项目进展不断更新。*
